<!-- TODO Move this to a template -->
<script src="https://kit.fontawesome.com/090ca49637.js" crossorigin="anonymous"></script>

<div class="container" data-controller="topics">
  <p style="color: green"><%= notice %></p>
  <p style="color: red"><%= alert %></p>
  
  <div class="page-header-row">
    <h1 class="page-header-title">₿uilder <%= @socratic_seminar.seminar_number %></h1>
    <div class="header-actions">
      <%= link_to 'Home', root_path, class: 'button', style: 'position: relative; top: -10px; font-size: 90%; padding: 0.375em 0.75em;' %>
      <% if @admin_mode %>
        <%= link_to 'New Topic', new_socratic_seminar_topic_path(@socratic_seminar), class: 'button' %>
      <% end %>
      <% if @admin_mode %>
        <%= button_to "Import Sections & Topics", import_sections_and_topics_socratic_seminar_topics_path(@socratic_seminar), 
                      method: :post, 
                      class: "button",
                      data: { confirm: "This will import sections and topics from bitcoinbuildersf.com for Builder #{@socratic_seminar.seminar_number}. Continue?" } %>
        <button onclick="showDeleteSectionsModal()" class="button button-danger">Delete Sections</button>
      <% end %>
    </div>
  </div>
  <div class="voting-instructions">
    <ul>
      <li>Vote for free with the Up & Down arrows. One vote per person.</li>
      <li>Send Lightning payments for additional votes. Each individual payment counts as 1 vote. Unlimited Lighting votes per person.</li>
      <li>All payments help pay for pizza.</li>
    </ul>
  </div>
  <% @sections.each do |section| %>
    <h2 class="section-title"><%= section.name %></h2>
    <ul>
      <% @topics.select { |topic| topic.section_id == section.id }.each do |topic| %>
        <% vote_state = (@vote_states && @vote_states[topic.id.to_s]) %>
        <li class="topic-list-item" data-topic-id="<%= topic.id %>" data-votes="<%= topic.votes || 0 %>">
          <div class="topic-header-row">
            <span class="topic-name">
              <%= link_to topic.name, socratic_seminar_topic_path(@socratic_seminar, topic) %>
              <% if topic.link.present? %>
                <span class="topic-link-desktop"> <%= link_to truncate(topic.link, length: 75), topic.link, target: "_blank", rel: "noopener" %></span>
              <% end %>
            </span>
          </div>
          <span class="vote-info-row">
            Votes: 
            <div class="vote-count" data-topics-target="voteCount"><%= topic.votes || 0 %></div>
            <div class="vote-buttons" style="display:inline-flex; vertical-align:middle; margin-left:0.5em;">
              <%= button_to upvote_socratic_seminar_topic_path(@socratic_seminar, topic), method: :post, class: 'vote-button', disabled: (vote_state == 'up'), form: { data: { topics_target: 'voteForm', turbo: 'false' } } do %>
                <span class="vote-arrow"><i class="fas fa-arrow-up"></i></span>
              <% end %>
              <%= button_to downvote_socratic_seminar_topic_path(@socratic_seminar, topic), method: :post, class: 'vote-button', disabled: (vote_state == 'down'), form: { data: { topics_target: 'voteForm', turbo: 'false' } } do %>
                <span class="vote-arrow"><i class="fas fa-arrow-down"></i></span>
              <% end %>
            </div>
            |
            Sats: 
            <i class="fak fa-satoshisymbol-solid"></i>
            <div class="sats-received"><%= topic.sats_received %></div>
            |
            <%= link_to "Vote with ⚡", "https://www.lnurlpay.com/#{topic.lnurl}", class: 'send-btc-link', target: "_blank", rel: "noopener" %>
          </span>
        </li>
      <% end %>
    </ul>
  <% end %>
</div>

<!-- Delete Sections Confirmation Modal -->
<div id="deleteSectionsModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
  <div style="background-color: white; margin: 15% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 500px;">
    <h3 style="color: #e74c3c; margin-top: 0;">⚠️ Warning: Delete All Sections</h3>
    <p>You are about to delete <strong>ALL</strong> Sections and Topics for this Seminar.</p>
    <p>This will also delete <strong>ALL Lightning Payments</strong> associated with the Topics.</p>
    <p style="color: #e74c3c; font-weight: bold;">This action cannot be undone!</p>
    
    <div style="margin-top: 20px; text-align: right;">
      <button onclick="hideDeleteSectionsModal()" class="button" style="margin-right: 10px;">Cancel</button>
      <%= button_to "Confirm & Delete", delete_sections_socratic_seminar_path(@socratic_seminar), 
                    method: :delete, 
                    class: "button button-danger",
                    data: { confirm: false } %>
    </div>
  </div>
</div>

<script>
function showDeleteSectionsModal() {
  document.getElementById('deleteSectionsModal').style.display = 'block';
}

function hideDeleteSectionsModal() {
  document.getElementById('deleteSectionsModal').style.display = 'none';
}

// Close modal when clicking outside of it
window.onclick = function(event) {
  var modal = document.getElementById('deleteSectionsModal');
  if (event.target == modal) {
    hideDeleteSectionsModal();
  }
}
</script>
